---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PhotoGallery, { type GalleryItem } from "../components/PhotoGallery";

const allPosts = (await getCollection("posts"))
    .filter((x) => !x.data.isDraft)
    .sort(
        (a, b) =>
            (b.data.pubDate as Date).valueOf() -
            (a.data.pubDate as Date).valueOf(),
    );

const pageTitle = "Truls Henrik";

const talks = (await getCollection("talks")).sort(
    (a, b) => (b.data.date as Date).valueOf() - (a.data.date as Date).valueOf(),
);

const talkEntries = await Promise.all(
    talks.map(async (talk) => ({
        ...talk,
        Content: (await talk.render()).Content,
    })),
);

const imageNames = ["headshot-1.avif", "headshot-2.avif", "headshot-3.avif"];
const galleryItems: GalleryItem[] = imageNames.map((x) => {
    return { original: `/images/${x}`, thumbnail: `/images/${x}` };
});
---

<BaseLayout pageTitle={pageTitle}>
    <section class="hero">
        <div class="hero__card reveal">
            <p class="eyebrow">Hjemmeside / Skriverier / Prosjekter</p>
            <h1>Truls Henrik</h1>
            <p class="lead">
                Jeg liker når ting gir mening. Helst for flere enn bare meg. Her
                samler jeg skriverier om visualisering, programmering og
                matematikk, med et mykt fokus på formidling og systemer som gjør
                ting lettere å forstå.
            </p>
        </div>
        <div class="hero__media">
            <div class="photo-stack" aria-hidden="true">
                <img
                    class="photo-card photo-card--front"
                    src="/images/headshot-1.avif"
                    alt=""
                    loading="lazy"
                />
                <img
                    class="photo-card photo-card--middle"
                    src="/images/headshot-2.avif"
                    alt=""
                    loading="lazy"
                />
                <img
                    class="photo-card photo-card--back"
                    src="/images/headshot-3.avif"
                    alt=""
                    loading="lazy"
                />
            </div>
            <button
                class="photo-stack__button"
                type="button"
                aria-haspopup="dialog"
                aria-controls="photo-gallery"
            >
                Se bilder
            </button>
        </div>
    </section>

    <section class="section" id="writing">
        <div class="stack reveal">
            <h2>Siste innlegg</h2>
            <p class="muted">
                Skriverier om visualisering, programmering og matte, med et
                menneskelig perspektiv.
            </p>
        </div>
        {
            allPosts.length ? (
                <ul class="list">
                    {allPosts.map((post) => (
                        <li class="list-item" transition:name={post.data.title}>
                            <a class="inline-link" href={`/blog/${post.slug}`}>
                                <h3>{post.data.title}</h3>
                            </a>
                            {post.data.excerpt && (
                                <p class="muted">{post.data.excerpt}</p>
                            )}
                            <span class="muted">
                                {(post.data.pubDate as Date).toLocaleDateString(
                                    "nb",
                                    {
                                        day: "2-digit",
                                        month: "long",
                                        year: "numeric",
                                    },
                                )}
                            </span>
                        </li>
                    ))}
                </ul>
            ) : (
                <div class="card reveal">
                    <h3>Ingen publiserte innlegg ennå</h3>
                    <p>
                        Jeg jobber med å fylle på. Kom gjerne tilbake snart,
                        eller{" "}
                        <a class="inline-link" href="mailto:post@truls.dev">
                            si hei på e-post
                        </a>
                        om du er nysgjerrig.
                    </p>
                </div>
            )
        }
    </section>

    <section class="section" id="talks">
        <div class="stack reveal">
            <h2>Videoer og foredrag</h2>
            <p class="muted">Et lite utvalg av opptak.</p>
        </div>
        <ul class="list">
            {
                talkEntries.map((talk) => (
                    <li class="list-item reveal">
                        <h3>{talk.data.title}</h3>
                        <div class="muted">
                            <talk.Content />
                        </div>
                        <div class="stack">
                            {talk.data.links.map(
                                (link: { label: string; href: string }) => (
                                    <a href={link.href}>{link.label}</a>
                                ),
                            )}
                        </div>
                    </li>
                ))
            }
        </ul>
    </section>

    <dialog class="photo-dialog" id="photo-gallery">
        <div class="photo-dialog__header">
            <h2>Bildegalleri</h2>
            <button class="photo-dialog__close" type="button">Lukk</button>
        </div>
        <div class="photo-dialog__grid">
            <PhotoGallery items={galleryItems} client:load />
        </div>
    </dialog>

    <script>
        const dialog = document.querySelector(
            "#photo-gallery",
        ) as HTMLDialogElement | null;
        const openButton = document.querySelector(
            ".photo-stack__button",
        ) as HTMLButtonElement | null;
        const closeButton = document.querySelector(
            ".photo-dialog__close",
        ) as HTMLButtonElement | null;

        const openDialog = () => {
            if (!dialog) return;
            if (typeof dialog.showModal === "function") {
                dialog.showModal();
            }
        };

        const closeDialog = () => {
            dialog?.close();
        };

        openButton?.addEventListener("click", openDialog);
        closeButton?.addEventListener("click", closeDialog);
        dialog?.addEventListener("click", (event) => {
            if (event.target === dialog) closeDialog();
        });
        dialog?.addEventListener("cancel", closeDialog);
    </script>
</BaseLayout>
